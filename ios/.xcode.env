# This `.xcode.env` file is versioned and is used to source the environment
# used when running script phases inside Xcode.
# To customize your local environment, you can create an `.xcode.env.local`
# file that is not versioned.

# NODE_BINARY variable contains the PATH to the node executable.
#
# Customize the NODE_BINARY variable here.
# For example, to use nvm with brew, add the following line
# . "$(brew --prefix nvm)/nvm.sh" --no-use

# Try to find node in common locations
if [ -z "$NODE_BINARY" ]; then
  # Try command -v first (works in most cases)
  NODE_BINARY=$(command -v node 2>/dev/null)
  
  # If not found, try common paths (including GitHub Actions paths)
  if [ -z "$NODE_BINARY" ] || [ ! -f "$NODE_BINARY" ]; then
    # GitHub Actions hosted toolcache path
    if [ -f "/Users/runner/hostedtoolcache/node/"*"/arm64/bin/node" ]; then
      NODE_BINARY=$(find /Users/runner/hostedtoolcache/node -name node -type f -executable 2>/dev/null | head -1)
    elif [ -f "/usr/local/bin/node" ]; then
      NODE_BINARY="/usr/local/bin/node"
    elif [ -f "/opt/homebrew/bin/node" ]; then
      NODE_BINARY="/opt/homebrew/bin/node"
    elif [ -f "$HOME/.nvm/versions/node/$(cat $HOME/.nvm/alias/default 2>/dev/null || echo 'v20')/bin/node" ]; then
      NODE_BINARY="$HOME/.nvm/versions/node/$(cat $HOME/.nvm/alias/default 2>/dev/null || echo 'v20')/bin/node"
    fi
  fi
fi

# Verify NODE_BINARY is set and executable
if [ -z "$NODE_BINARY" ]; then
  echo "Error: NODE_BINARY is not set. Please set it in .xcode.env.local" >&2
  exit 1
fi

if [ ! -f "$NODE_BINARY" ] || [ ! -x "$NODE_BINARY" ]; then
  echo "Error: NODE_BINARY at '$NODE_BINARY' is not accessible or executable" >&2
  exit 1
fi

export NODE_BINARY

# REACT_NATIVE_PATH: Try to detect if not already set
# This is used by React Native bundling scripts
if [ -z "$REACT_NATIVE_PATH" ]; then
  # Try to find react-native relative to the script location
  # The script runs from ios/ directory, so look for ../node_modules/react-native
  if [ -d "$(dirname "$0")/../node_modules/react-native" ]; then
    REACT_NATIVE_PATH="$(cd "$(dirname "$0")/../node_modules/react-native" && pwd)"
  elif [ -d "$SRCROOT/../node_modules/react-native" ]; then
    REACT_NATIVE_PATH="$(cd "$SRCROOT/../node_modules/react-native" && pwd)"
  fi
fi

# Export REACT_NATIVE_PATH if found (won't fail if not found, script will handle it)
if [ -n "$REACT_NATIVE_PATH" ]; then
  export REACT_NATIVE_PATH
fi
